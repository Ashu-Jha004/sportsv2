generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// EXISTING ATHLETE MODEL (ENHANCED)
// ============================================
model Athlete {
  id                    String              @id @default(cuid())
  clerkUserId           String              @unique
  username              String              @unique
  email                 String              @unique
  firstName             String
  lastName              String
  profileImage          String?
  dateOfBirth           DateTime
  gender                Gender
  bio                   String?
  primarySport          Sport
  secondarySport        Sport?
  rank                  Rank                @default(PAWN)
  class                 Class               @default(E)
  roles                 Role[]              @default([ATHLETE])
  isAdmin               Boolean             @default(false)
  country               String
  state                 String
  city                  String
  latitude              Float
  longitude             Float
  onboardingComplete    Boolean             @default(false)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  associateProfile       AssociateProfile?
  associateApplication   AssociateApplication?
  reviewedApplications   AssociateApplication[] @relation("AdminReviewer")
  sentNotifications      Notification[]       @relation("NotificationSender")
  receivedNotifications  Notification[]       @relation("NotificationRecipient")

  // Friendships
  sentFriendRequests     FriendRequest[]      @relation("FriendRequestSender")
  receivedFriendRequests FriendRequest[]      @relation("FriendRequestReceiver")

  friendshipsAsUserA     Friendship[]         @relation("FriendshipUserA")
  friendshipsAsUserB     Friendship[]         @relation("FriendshipUserB")

  // Messaging
  conversations          Conversation[]       @relation("ConversationParticipants")
  messagesSent           Message[]            @relation("MessagesSent")

  @@index([clerkUserId])
  @@index([country, state, city])
  @@index([username, firstName, email])
  @@index([latitude, longitude])
  @@index([roles])
}

// ============================================
// ASSOCIATE/GUIDE/MODERATOR PROFILE
// ============================================
model AssociateProfile {
  id                 String      @id @default(cuid())
  athleteId          String      @unique
  athlete            Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  // Professional Information
  workEmail          String      @unique
  resumeUrl          String      // Cloudinary or storage URL
  primaryExpertise   Sport       // Primary sport expertise
  secondaryExpertise Sport[]     // List of secondary sports
  yearsOfExperience  Int

  // Location (can differ from athlete's personal address)
  workCountry        String
  workState          String
  workCity           String
  workLatitude       Float
  workLongitude      Float

  // Status
  isActive           Boolean     @default(true)
  verifiedAt         DateTime?   // When admin approved

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([athleteId])
  @@index([primaryExpertise])
  @@index([isActive])
  @@index([workCountry, workState, workCity])
}

// ============================================
// ASSOCIATE APPLICATION WORKFLOW
// ============================================
model AssociateApplication {
  id                 String              @id @default(cuid())
  athleteId          String              @unique
  athlete            Athlete             @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  // Application Details
  workEmail          String
  resumeUrl          String
  primaryExpertise   Sport
  secondaryExpertise Sport[]
  yearsOfExperience  Int

  // Location
  workCountry        String
  workState          String
  workCity           String
  workLatitude       Float
  workLongitude      Float

  // Cover Letter / Motivation
  coverLetter        String?

  // Application Status
  status             ApplicationStatus   @default(PENDING)

  // Admin Review
  reviewedById       String?
  reviewedBy         Athlete?            @relation("AdminReviewer", fields: [reviewedById], references: [id])
  reviewedAt         DateTime?
  reviewNotes        String?
  rejectionReason    String?

  // Add this field
  canReapplyAfter    DateTime?           // When athlete can reapply after rejection

  // Timestamps
  submittedAt        DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([athleteId])
  @@index([status])
  @@index([reviewedById])
  @@index([submittedAt])
  @@index([canReapplyAfter])  // Add index for efficient queries
}

// ============================================
// NOTIFICATION SYSTEM (POLYMORPHIC DESIGN)
// ============================================
model Notification {
  id              String          @id @default(cuid())

  // Recipient
  recipientId     String
  recipient       Athlete         @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  // Sender (nullable for system notifications)
  senderId        String?
  sender          Athlete?        @relation("NotificationSender", fields: [senderId], references: [id])

  // Notification Content
  type            NotificationType
  title           String
  message         String

  // Polymorphic Reference (for linking to related entities)
  entityType      String?         // e.g., "AssociateApplication", "Post", "Message"
  entityId        String?         // ID of the related entity

  // Metadata (JSON for extensibility)
  metadata        Json?           // Store additional data specific to notification type

  // Status
  isRead          Boolean         @default(false)
  readAt          DateTime?

  // Action URL (deep link)
  actionUrl       String?

  createdAt       DateTime        @default(now())
  expiresAt       DateTime?       // Optional: for time-sensitive notifications

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
  @@index([type])
  @@index([entityType, entityId])
}

// ============================================
// FRIEND SYSTEM
// ============================================
model FriendRequest {
  id          String              @id @default(cuid())
  senderId    String
  sender      Athlete             @relation("FriendRequestSender", fields: [senderId], references: [id])
  receiverId  String
  receiver    Athlete             @relation("FriendRequestReceiver", fields: [receiverId], references: [id])
  status      FriendRequestStatus @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
}

model Friendship {
  id        String   @id @default(cuid())
  userAId   String
  userBId   String
  userA     Athlete  @relation("FriendshipUserA", fields: [userAId], references: [id])
  userB     Athlete  @relation("FriendshipUserB", fields: [userBId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
}

// ============================================
// MESSAGING SYSTEM
// ============================================
model Conversation {
  id           String       @id @default(cuid())
  participants Athlete[]    @relation("ConversationParticipants") // Implicit many-to-many, do not add references
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  messages     Message[]

  @@index([createdAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         Athlete      @relation("MessagesSent", fields: [senderId], references: [id])
  content        String
  createdAt      DateTime     @default(now())
imageUrl String?
  @@index([conversationId])
  @@index([senderId])
}
model match{
id             String       @id @default(cuid())
matchTitle       String?
wins            Int?
losses          Int?
}

// ============================================
// ENUMS
// ============================================

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum Role {
  ATHLETE
  ASSOCIATE     // Guide/Moderator
  ADMIN
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum NotificationType {
  APPLICATION_SUBMITTED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  APPLICATION_UNDER_REVIEW
  SYSTEM_ANNOUNCEMENT
  ACCOUNT_UPDATE
  SECURITY_ALERT
  NEW_FOLLOWER
  NEW_MESSAGE
  POST_LIKED
  POST_COMMENTED
  MENTION
  GUIDE_ASSIGNED
  TRAINING_SCHEDULED
  EVENT_INVITATION
  ROLE_UPDATED
  PROFILE_FLAGGED
  CUSTOM
}

enum Rank {
  KING
  PAWN
  ROOK
  KNIGHT
  BISHOP
  QUEEN
}

enum Class {
  A
  B
  C
  D
  E
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum Sport {
  FOOTBALL
  BASKETBALL
  CRICKET
  TENNIS
  RUNNING
  SWIMMING
  BADMINTON
  VOLLEYBALL
  HOCKEY
  ATHLETICS
  WRESTLING
  BOXING
  MARTIAL_ARTS
  CYCLING
  GOLF
  OTHER
}
